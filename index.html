<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>PowerNotes</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;padding:16px;font-family:sans-serif}
section{max-width:800px;margin:auto}
[hidden]{display:none}
ul{padding:0}
li{list-style:none;padding:8px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;cursor:pointer}
.memo-right{display:flex;gap:8px;align-items:center}
.date-span{font-size:.7em;color:#666}
.menu-popup{position:absolute;background:#fff;border:1px solid #ccc;display:none}
#editor{min-height:60vh;border-top:1px solid #ccc;padding-top:8px}
</style>
</head>
<body>

<section id="view-login">
  <h2>Login</h2>
  <input id="email" placeholder="email"><br>
  <input id="password" type="password" placeholder="password"><br>
  <button id="login">Login</button>
  <button id="signup">Sign up</button><br>
  <button id="google-login">Google</button>
</section>

<section id="view-list" hidden>
  <h2>Notes</h2>
  <button id="new-memo">New</button>
  <button id="go-trash">Trash</button>
  <ul id="memo-list"></ul>
</section>

<section id="view-trash" hidden>
  <h2>Trash</h2>
  <button id="back-list">← Back</button>
  <ul id="trash-list"></ul>
</section>

<section id="view-editor" hidden>
  <button id="back">← Back</button>
  <input id="title" placeholder="title">
  <div id="editor" contenteditable="true"></div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth,onAuthStateChanged,signInWithEmailAndPassword,createUserWithEmailAndPassword,GoogleAuthProvider,signInWithPopup,signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore,collection,addDoc,getDocs,doc,getDoc,setDoc,query,orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCdDf0GH80PoGlcbk2yjlaVQfP01Gk9m18",
  authDomain:"noteeditor-ba1db.firebaseapp.com",
  projectId:"noteeditor-ba1db"
});
const auth=getAuth(app);
const db=getFirestore(app);

const views={
  login:loginView=document.getElementById('view-login'),
  list:document.getElementById('view-list'),
  trash:document.getElementById('view-trash'),
  editor:document.getElementById('view-editor')
};

const memoList=document.getElementById('memo-list');
const trashList=document.getElementById('trash-list');
const editor=document.getElementById('editor');
const titleInput=document.getElementById('title');

let currentMemoId=null;

function show(v){
  Object.values(views).forEach(x=>x.hidden=true);
  views[v].hidden=false;
}

/* ---------- Auth ---------- */
document.getElementById('login').onclick=()=>signInWithEmailAndPassword(auth,email.value,password.value);
document.getElementById('signup').onclick=()=>createUserWithEmailAndPassword(auth,email.value,password.value);
document.getElementById('google-login').onclick=()=>signInWithPopup(auth,new GoogleAuthProvider());

onAuthStateChanged(auth,u=>{
  if(!u){
    location.hash='#login';
  }else if(!location.hash||location.hash==='#login'){
    location.hash='#/list';
  }
  navigate();
});

/* ---------- Router ---------- */
window.addEventListener('hashchange',()=>auth.currentUser&&navigate());

async function navigate(){
  const h=location.hash;
  if(h==='#login'){ show('login'); return; }
  if(h==='#/list'){ await loadMemos(); show('list'); return; }
  if(h==='#/trash'){ await loadTrash(); show('trash'); return; }
  if(h.startsWith('#/editor/')){
    await openEditor(h.split('/')[2]);
    show('editor');
  }
}

/* ---------- List ---------- */
async function loadMemos(){
  memoList.innerHTML='';
  const q=query(collection(db,'users',auth.currentUser.uid,'memos'),orderBy('updated','desc'));
  (await getDocs(q)).forEach(d=>{
    const m=d.data(); if(m.deletedAt) return;
    const li=document.createElement('li');
    li.textContent=m.title||'Untitled';
    const s=document.createElement('span');
    s.className='date-span';
    s.textContent=new Date(m.updated).toLocaleString();
    li.appendChild(s);
    li.onclick=()=>location.hash=`#/editor/${d.id}`;
    memoList.appendChild(li);
  });
}

/* ---------- Trash ---------- */
async function loadTrash(){
  trashList.innerHTML='';
  const q=query(collection(db,'users',auth.currentUser.uid,'memos'),orderBy('deletedAt','desc'));
  (await getDocs(q)).forEach(d=>{
    const m=d.data(); if(!m.deletedAt) return;
    const li=document.createElement('li');
    li.textContent=m.title||'Untitled';
    const btn=document.createElement('button');
    btn.textContent='Restore';
    btn.onclick=async e=>{
      e.stopPropagation();
      await setDoc(doc(db,'users',auth.currentUser.uid,'memos',d.id),{deletedAt:null},{merge:true});
      li.remove();
    };
    li.appendChild(btn);
    trashList.appendChild(li);
  });
}

/* ---------- Editor ---------- */
async function openEditor(id){
  currentMemoId=id;
  const d=(await getDoc(doc(db,'users',auth.currentUser.uid,'memos',id))).data();
  titleInput.value=d.title||'';
  editor.innerHTML=d.content||'';
}

async function save(){
  if(!currentMemoId) return;
  await setDoc(doc(db,'users',auth.currentUser.uid,'memos',currentMemoId),{
    title:titleInput.value,
    content:editor.innerHTML,
    updated:Date.now()
  },{merge:true});
}
editor.oninput=save;
titleInput.oninput=save;

/* ---------- Buttons ---------- */
document.getElementById('new-memo').onclick=async()=>{
  const r=await addDoc(collection(db,'users',auth.currentUser.uid,'memos'),{
    title:'',content:'',updated:Date.now(),deletedAt:null
  });
  location.hash=`#/editor/${r.id}`;
};
document.getElementById('go-trash').onclick=()=>location.hash='#/trash';
document.getElementById('back-list').onclick=()=>location.hash='#/list';
document.getElementById('back').onclick=()=>location.hash='#/list';
</script>
</body>
</html>
